version: "3.8"

services:
  # ---------------------------------------------------------------------------
  # SERVICIOS DE COORDINACIÓN (Zookeeper)
  # Necesario para el cluster de NiFi
  # ---------------------------------------------------------------------------
  zookeeper:
    hostname: myzookeeper
    container_name: zookeeper_container
    image: 'zookeeper:3.7'
    restart: always
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    networks:
      - dataworld
    # No requiere healthcheck complejo, el arranque es rápido

  # ---------------------------------------------------------------------------
  # SERVICIOS DE INGESTA Y TRANSFORMACIÓN (Apache NiFi)
  # ---------------------------------------------------------------------------
  nifi:
    hostname: mynifi
    container_name: nifi_container
    image: apache/nifi:latest # Nota: Versión antigua. Considerar actualizar a 1.20+
    restart: on-failure
    ports:
      - "8091:8080" # UI de NiFi accesible en localhost:8091
    environment:
      - NIFI_WEB_HTTP_PORT=8080
      - NIFI_CLUSTER_IS_NODE=true
      - NIFI_CLUSTER_NODE_PROTOCOL_PORT=8082
      - NIFI_ZK_CONNECT_STRING=myzookeeper:2181
      - NIFI_ELECTION_MAX_WAIT=30 sec
      - NIFI_SENSITIVE_PROPS_KEY='12345678901234567890A'
    volumes:
      # Volúmenes persistentes para el estado interno de NiFi
      - nifi-database_repository:/opt/nifi/nifi-current/database_repository
      - nifi-flowfile_repository:/opt/nifi/nifi-current/flowfile_repository
      - nifi-content_repository:/opt/nifi/nifi-current/content_repository
      - nifi-provenance_repository:/opt/nifi/nifi-current/provenance_repository
      - nifi-conf:/opt/nifi/nifi-current/conf
      - nifi-state:/opt/nifi/nifi-current/state
      # Mapeos locales (asegúrate de que estas carpetas existen en tu host)
      - ./nifi/logs:/opt/nifi/nifi-current/logs
      - ./nifi/jdbc:/opt/nifi/nifi-current/jdbc
      - ./nifi/credentials:/opt/nifi/nifi-current/credentials
      - ./nifi/sample_data:/opt/nifi/nifi-current/sample_data
      - ./nifi/sample_dataflows:/opt/nifi/nifi-current/sample
    networks:
      - dataworld
    depends_on:
      - zookeeper # NiFi espera a que Zookeeper inicie
    healthcheck:
      test: ["CMD", "curl", "-f", "http://mynifi:8080/nifi/"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ---------------------------------------------------------------------------
  # CONTROL DE VERSIONES (NiFi Registry)
  # ---------------------------------------------------------------------------
  registry:
    hostname: myregistry
    container_name: registry_container
    image: 'apache/nifi-registry:latest'
    restart: on-failure
    ports:
      - "18080:18080"
    environment:
      - LOG_LEVEL=INFO
      - NIFI_REGISTRY_DB_DIR=/opt/nifi-registry/nifi-registry-current/database
      - NIFI_REGISTRY_FLOW_PROVIDER=file
      - NIFI_REGISTRY_FLOW_STORAGE_DIR=/opt/nifi-registry/nifi-registry-current/flow_storage
    volumes:
      - ./nifi_registry/database:/opt/nifi-registry/nifi-registry-current/database
      - ./nifi_registry/flow_storage:/opt/nifi-registry/nifi-registry-current/flow_storage
    networks:
      - dataworld
    healthcheck:
      test: ["CMD", "curl", "-f", "http://myregistry:18080/nifi-registry/"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ---------------------------------------------------------------------------
  # BASE DE DATOS RELACIONAL (PostgreSQL)
  # ---------------------------------------------------------------------------
  postgres:
    hostname: mypostgres
    container_name: postgres_container
    image: 'postgres:14-bullseye'
    restart: on-failure
    environment:
      POSTGRES_USER: 'postgres'
      POSTGRES_PASSWORD: 'postgres'
      PGDATA: /data/postgres
    volumes:
      - postgres-data:/data/postgres # Usamos un nombre de volumen más claro
    ports:
      - "5432:5432"
    networks:
      - dataworld
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "postgres"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ---------------------------------------------------------------------------
  # ADMINISTRACIÓN DE BD (pgAdmin)
  # ---------------------------------------------------------------------------
  pgadmin:
    hostname: mypgadmin
    container_name: pgadmin_container
    image: 'dpage/pgadmin4:6.1'
    restart: on-failure
    environment:
      PGADMIN_DEFAULT_EMAIL: 'pgadmin4@pgadmin.org'
      PGADMIN_DEFAULT_PASSWORD: 'admin'
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    volumes:
      - pgadmin-data:/var/lib/pgadmin
    ports:
      - "5050:80"
    networks:
      - dataworld
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:80/misc/ping"]
      interval: 30s
      timeout: 20s
      retries: 3

# ---------------------------------------------------------------------------
# VOLÚMENES Y REDES
# ---------------------------------------------------------------------------
volumes:
  nifi-database_repository:
  nifi-flowfile_repository:
  nifi-content_repository:
  nifi-provenance_repository:
  nifi-state:
  nifi-conf:
  postgres-data: # Renombrado de 'postgres' para evitar confusión con el servicio
  pgadmin-data:  # Renombrado de 'pgadmin'

networks:
  dataworld:
    driver: bridge
